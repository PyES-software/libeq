"Test collection for potentiometry data fitting."

import numpy as np
from libeq.data_structure import SolverData, PotentiometryOptions, PotentiometryTitrationsParameters
from libeq import PotentiometryOptimizer


def test_first():
    titration1 = PotentiometryTitrationsParameters(
        electro_active_compoment=2,
        e0=450.0,
        e0_sigma=0.01,
        slope=-59.16,
        v0=25.0,
        v0_sigma=0.01,
        c0 = np.array([0.5, 0.5, 25.0]),
        ct = np.array([0.0, 0.0, -0.1]),
        v_add = np.array([ 0.00, 0.08, 0.16, 0.24, 0.32, 0.40, 0.48, 0.56, 0.64, 0.72, 0.80, 
                           0.88, 0.96, 1.04, 1.12, 1.20, 1.28, 1.36, 1.44, 1.52, 1.60, 1.68, 
                           1.76, 1.84, 1.92, 2.00, 2.08, 2.16, 2.24, 2.32, 2.40, 2.48, 2.56, 
                           2.64, 2.72, 2.80, 2.88, 2.96, 3.04, 3.12, 3.20, 3.28, 3.36, 3.44, 
                           3.52, 3.60, 3.68, 3.76, 3.84, 3.92, 4.00, 4.08, 4.16, 4.24, 4.32, 
                           4.40, 4.48, 4.56, 4.64, 4.72, 4.80, 4.88, 4.96, 5.04, 5.12, 5.20, 
                           5.28, 5.36, 5.44, 5.52, 5.60, 5.68, 5.76, 5.84, 5.92, 6.00, 6.08, 
                           6.16, 6.24, 6.32, 6.40, 6.48, 6.56, 6.64, 6.72, 6.80, 6.88, 6.96, 
                           7.04, 7.12, 7.2 , 7.28, 7.36, 7.44, 7.52, 7.6 , 7.68, 7.76, 7.84, 
                           7.92, 8.00, 8.08, 8.16, 8.24, 8.32, 8.4 , 8.48, 8.56, 8.64, 8.72, 
                           8.8 , 8.88, 8.96, 9.04, 9.12, 9.2 , 9.28, 9.36, 9.44, 9.52, 9.6, 
                           9.68, 9.76, 9.84, 9.92, 10.0, 10.08, 10.16, 10.24, 10.32, 10.4, 10.48, 
                           10.56, 10.64, 10.72, 10.8 , 10.88, 10.96, 11.04, 11.12, 11.2, 
                           11.28, 11.36, 11.44, 11.52, 11.6 , 11.68, 11.76, 11.84, 11.92]),
        emf = np.array([ 308.4, 308.0, 307.5, 307.1, 306.7, 306.2, 305.8, 305.3, 304.9, 304.4, 
                         304.0, 303.5, 303.0, 302.5, 302.1, 301.6, 301.1, 300.6, 300.1, 299.5, 
                         299.0, 298.5, 298.0, 297.4, 296.9, 296.3, 295.7, 295.1, 294.5, 293.9, 
                         293.3, 292.7, 292.1, 291.4, 290.8, 290.1, 289.4, 288.7, 288.0, 287.2, 
                         286.5, 285.7, 284.9, 284.1, 283.3, 282.4, 281.6, 280.6, 279.7, 278.8, 
                         277.8, 276.7, 275.7, 274.5, 273.4, 272.2, 270.9, 269.6, 268.3, 266.8, 
                         265.3, 263.7, 262.0, 260.2, 258.3, 256.2, 253.9, 251.5, 248.8, 245.9, 
                         242.6, 238.9, 234.6, 229.5, 223.4, 215.6, 204.8, 187.5, 129.8, -192.8, 
                         -212.4, -223.3, -231.0, -236.8, -241.6, -245.6, -249.1, -252.1, -254.8, 
                         -257.3, -259.5, -261.5, -263.4, -265.2, -266.8, -268.3, -269.8, -271.1, 
                         -272.4, -273.6, -274.8, -275.9, -276.9, -278.0, -278.9, -279.8, -280.7, 
                         -281.6, -282.4, -283.2, -284.0, -284.7, -285.5, -286.2, -286.8, -287.5, 
                         -288.1, -288.7, -289.3, -289.9, -290.5, -291.1, -291.6, -292.1, -292.6, 
                         -293.1, -293.6, -294.1, -294.6, -295.0, -295.5, -295.9, -296.4, -296.8, 
                         -297.2, -297.6, -298.0, -298.4, -298.8, -299.1, -299.5, -299.9, -300.2, 
                         -300.6, -300.9, -301.2, -301.6, -301.9, -302.2, -302.5 ])
    )
    titration2 = PotentiometryTitrationsParameters(
        electro_active_compoment=2,
        e0=450.0,
        e0_sigma=0.01,
        slope=-59.16,
        v0=25.0,
        v0_sigma=0.01,
        c0 = np.array([1.0, 1.0, 25.0]),
        ct = np.array([0.0, 0.0, -0.1]),
        v_add = np.array([ 0.00, 0.08, 0.16, 0.24, 0.32, 0.40, 0.48, 0.56, 0.64, 0.72, 0.80, 
                           0.88, 0.96, 1.04, 1.12, 1.20, 1.28, 1.36, 1.44, 1.52, 1.60, 1.68, 
                           1.76, 1.84, 1.92, 2.00, 2.08, 2.16, 2.24, 2.32, 2.40, 2.48, 2.56, 
                           2.64, 2.72, 2.80, 2.88, 2.96, 3.04, 3.12, 3.20, 3.28, 3.36, 3.44, 
                           3.52, 3.60, 3.68, 3.76, 3.84, 3.92, 4.00, 4.08, 4.16, 4.24, 4.32, 
                           4.40, 4.48, 4.56, 4.64, 4.72, 4.80, 4.88, 4.96, 5.04, 5.12, 5.20, 
                           5.28, 5.36, 5.44, 5.52, 5.60, 5.68, 5.76, 5.84, 5.92, 6.00, 6.08, 
                           6.16, 6.24, 6.32, 6.40, 6.48, 6.56, 6.64, 6.72, 6.80, 6.88, 6.96, 
                           7.04, 7.12, 7.2 , 7.28, 7.36, 7.44, 7.52, 7.6 , 7.68, 7.76, 7.84, 
                           7.92, 8.00, 8.08, 8.16, 8.24, 8.32, 8.4 , 8.48, 8.56, 8.64, 8.72, 
                           8.8 , 8.88, 8.96, 9.04, 9.12, 9.2 , 9.28, 9.36, 9.44, 9.52, 9.6, 
                           9.68, 9.76, 9.84, 9.92, 10.0, 10.08, 10.16, 10.24, 10.32, 10.4, 10.48, 
                           10.56, 10.64, 10.72, 10.8 , 10.88, 10.96, 11.04, 11.12, 11.2, 
                           11.28, 11.36, 11.44, 11.52, 11.6 , 11.68, 11.76, 11.84, 11.92]),
        emf = np.array([ 306.9, 306.5, 306.1, 305.6, 305.2, 304.8, 304.3, 303.9, 303.4, 303.0, 
                         302.5, 302.0, 301.6, 301.1, 300.6, 300.1, 299.6, 299.1, 298.6, 298.1,
                         297.6, 297.0, 296.5, 295.9, 295.4, 294.8, 294.2, 293.7, 293.1, 292.5,
                         291.8, 291.2, 290.6, 289.9, 289.2, 288.6, 287.9, 287.1, 286.4, 285.7,
                         284.9, 284.1, 283.3, 282.5, 281.6, 280.7, 279.8, 278.9, 278.0, 277.0,
                         275.9, 274.9, 273.8, 272.6, 271.4, 270.2, 268.9, 267.5, 266.1, 264.5,
                         263.0, 261.3, 259.5, 257.6, 255.5, 253.3, 250.9, 248.3, 245.5, 242.3,
                         238.8, 234.8, 230.2, 224.8, 218.3, 210.1, 199.0, 181.3, 123.3, -191.4,
                         -211.0, -222.0, -229.7, -235.6, -240.4, -244.5, -248.0, -251.0, -253.8,
                         -256.2, -258.5, -260.6, -262.5, -264.2, -265.9, -267.4, -268.9, -270.3,
                         -271.6, -272.8, -274.0, -275.1, -276.2, -277.2, -278.2, -279.1, -280.0,
                         -280.9, -281.7, -282.5, -283.3, -284.1, -284.8, -285.5, -286.2, -286.9,
                         -287.5, -288.1, -288.8, -289.3, -289.9, -290.5, -291.0, -291.6, -292.1,
                         -292.6, -293.1, -293.6, -294.1, -294.5, -295.0, -295.4, -295.9, -296.3,
                         -296.7, -297.1, -297.5, -297.9, -298.3, -298.7, -299.1, -299.4, -299.8,
                         -300.1, -300.5, -300.8, -301.2, -301.5, -301.8, -302.1])
    )
    pot = PotentiometryOptions(
        titrations = [ titration1, titration2 ],
        beta_flags = [0,0,0,0,0,0,0,0,0,0,0,1,1,1,0]
    )
    sd = SolverData(
        components = ['EDTA', 'Zn', 'H'],
        charges = [ -4, 2, 1 ],
        stoichiometry = np.array([[1,0, 1],
                                  [1,0, 2],
                                  [1,0, 3],
                                  [1,0, 4],
                                  [1,0, 5],
                                  [0,1,-1],
                                  [0,1,-2],
                                  [0,1,-3],
                                  [0,1,-4],
                                  [0,2,-1],
                                  [0,2,-6],
                                  [1,1, 0],
                                  [1,1, 1],
                                  [1,1,-1],
                                  [0,0,-1]], dtype=int).T,
        solid_stoichiometry = np.array([[]], dtype=int),
        log_beta = np.array([ 10.19, 
                              16.32, 
                              19.01, 
                              21.01, 
                              22.51, 
                              -9.15, 
                             -17.1, 
                             -28.39, 
                             -40.71, 
                              -8.89, 
                             -57.53, 
                              16.25, 
                              19.25, 
                               4.65, 
                              -13.78]),
        potentiometry_opts = pot
    )
    # breakpoint()
    result = PotentiometryOptimizer(sd)
    x, concs, final_log_beta, b_error, cor_matrix, cov_matrix, return_extra = result
    print(result)

